# Off-Path TCP Exploit

We discover a subtle yet serious timing side channel that exists in all generations of IEEE 802.11 or Wi-Fi technology, due to the fact that they are half-duplex. By exploiting the vulnerability, we are able to constrcut reliable and practical off-path TCP injection attacks against the laterst versions of all three major operating systems (macOS, Windows, and Linux). Our attac only requires a devicce connected to the Internet via a wireless router, and be reachable from an attack server. The thread model is that a user is lured to visit a malicious website first and then the puppet (i.e., a malicious javascript) running in a browser collaborates with an off-path adversary to hijack a TCP connection between the client and server for the prupose of injecting a spurious HTTP response that will be cached in the browser. Later on, when the victim accesses to the server, the browser would load the cached object (e.g., a script) rather than request it again. Notice that the victim connection is established and preserved by the puppet who repeatedly includes HTML elements (e.g, images). See [web-cache poisoning atttacks](https://people.eecs.berkeley.edu/~yahel/papers/Browser-Cache-Poisoning.Song.Spring10.attack-project.pdf) for more background.

## Supported Platforms
[Windows](https://github.com/seclab-ucr/tcp_exploit)

[MacOS](https://github.com/seclab-ucr/tcp_exploit/tree/release_mac/)

[Linux] TO DO

## How to build
	1.1 sudo apt-get install libnetfilter-queue-dev

	1.2 cd tcp_exploit/server/src

	1.3 sh build.sh

## Notice

You have to adjust some IP addresses in the source code as follows: Change the IP address of the attacker's machine at line 163 in the file `tcp_exploit/client/src/index.html`.

Since our victim [website](www.bbc.com) is subject to change, we also need to update the target object in our source code. Currently the target object is a [script](http://static.bbci.co.uk/frameworks/barlesque/3.22.55/orb/4/script/orb/api.min.js), which will be automatically loaded into the homepage of BBC. If you notice that the script is no longer exist (or present) in the homepage, there should be a similar script like ``http://static.bbci.co.uk/frameworks/barlesque/VERSION/orb/4/script/orb/api.min.js``, where 'VERSION' varies from time to time; in which case, you need to copy and paste the exact URL to replace the old one at line 158 in `client/src/index.html`.

During the attack's process, the TCP receive window size would grow as we keep requesting images. Based on the maximum window size that the client can achieve, you need to adjust the following at line 448 in the file `tcp_exploit/server/src/main.c`:
	`#define SEQ_WINDOW MAX_WINDOW_SIZE << 2`
where MAX_WINDOW_SIZE is the maximum window size representing the available space at the receiver's side.

## Set up environment
In order to set up the environment, we need one windows machine as the victim and one linux machine as the attacker. Our target website is `www.bbc.com`.

Network Topology:

    Attacker -------wire----------|
                               Router ---------wireless-------Victim(client)
    Server   -------wire----------|

On the attacker's machine, run the commands below:

	2.1 cd tcp_exploit/server

	2.2 sudo sh iptables.sh

	2.3 cd tcp_exploit/server/src

	2.4 sudo ./server

	2.5 cd tcp_exploit/client/src

	2.6 sudo python -m SimpleHTTPServer 80 (Alternatively, you can access to the malicious code (i.e., tcp_exploit/src/index.html) without setting up the HTTP server if you open the html file in browsers locally.)

## How to conduct experiment
	3.1 Launch Chrome and then access to the malicious website (http://attacker's IP address or file:///Path_to_the_dir/tcp_exploit/client/src/index.html)

	3.2 After the attack program finishes, you can access to the victim's website (i.e. www.bbc.com) to see whether the attack has successfully injected a page cached on the browser.

## Disclaimer
This is a reasearch-oriented project. Anyone using it should be aware of the potential risks and responsible for his/her own actions.

## Reference (To Do)